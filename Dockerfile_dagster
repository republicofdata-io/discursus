# Dagster libraries to run both dagit and the dagster-daemon. Does not
# need to have access to any pipeline code.

FROM python:3.9.16-buster

# Environment variables
ENV DAGSTER_HOME=/opt/dagster/dagster_home/


# Install the python package managers.
RUN pip install -U \
    pip \
    poetry


# Copy the contents of the project root directory to the app directory in the container
COPY . .


# Create tmp repostiory for local temporary job files to be copied to
RUN mkdir -p ./tmp


# Install dependancies
COPY poetry.lock pyproject.toml ./

RUN poetry config virtualenvs.create false \
  && poetry install


# Copy dagster instance and workspace YAML
RUN mkdir -p $DAGSTER_HOME

COPY discursus_data_platform/dagster.yaml discursus_data_platform/workspace.yaml $DAGSTER_HOME

WORKDIR $DAGSTER_HOME
